<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Source Configuration</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
</head>
<body>
    <header class="header">
        <h1 style="color: #0C234B;"><i class="fa-solid fa-database"></i> Data Source Configuration</h1>
    </header>
    <div class="config-container">
        <div class="config-content">
            <div class="form-section">
                <h2 style="color: #900C3F;"><i class="fa-solid fa-cogs"></i> Configure Your Data Sources</h2>
                <div id="message"></div>
                <div id="spinner" class="spinner" style="display: none;">
                    <div class="lds-ring"><div></div><div></div><div></div><div></div></div>
                    <p>Saving configuration, please wait...</p>
                </div>
                <form action="/save_config" method="POST" onsubmit="submitForm(event)">
                    <div id="dataSources"></div>
                    <div id="targetSection" class="form-section" style="display: none;">
                        <h3 style="color: #900C3F;"><i class="fa-solid fa-bullseye"></i> Target Variable</h3>
                        <select id="targetVariable" name="target_variable" required></select>
                        <h3 style="color: #900C3F;"><i class="fa-solid fa-id-badge"></i> Identifier Variable</h3>
                        <select id="identifierVariable" name="identifier" required></select>
                    </div>
                    <div class="button-group">
                        <button type="button" class="btn-primary" onclick="addDataSource()">
                            <i class="fa-solid fa-plus"></i> Add Data Source
                        </button>
                        <button type="submit" class="btn-primary">
                            <i class="fa-solid fa-save"></i> Save Configuration
                        </button>
                    </div>
                </form>
            </div>

            <div class="visual-section">
                <h2 style="color: #0C234B;"><i class="fa-solid fa-sitemap"></i> Data Sources Visualization</h2>
                <div id="visualization" class="visualization-box">
                    <p>No data sources added yet.</p>
                </div>
            </div>
        </div>
    </div>
    <footer class="footer">
        <p>&copy; 2025 University of Arizona - Data Management Platform</p>
    </footer>
    <script>
    // Global Variables
    let globalUID = null;

    // Form Submission
    function submitForm(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        fetch(form.action, {
            method: "POST",
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById("message").innerText = data.message;
        })
        .catch(error => console.error("Error saving configuration:", error));
    }

    // Feature Handling
    function toggleSensitive(element) {
        const featureInput = element.parentElement.previousElementSibling;
        if (element.checked) {
            featureInput.classList.add("sensitive-overlay");
        } else {
            featureInput.classList.remove("sensitive-overlay");
        }
        updateVisualization();
    }

    function addFeature(sourceId) {
        const featureContainer = document.getElementById(`features_${sourceId}`);
        const featureCount = featureContainer.children.length + 1;

        const featureDiv = document.createElement('div');
        featureDiv.className = 'feature-item';
        featureDiv.innerHTML = `
            <input type="text" name="feature_name_${sourceId}_${featureCount}" placeholder="Enter feature name" required>
            <label class="sensitive-label">
                <input type="checkbox" name="sensitive_${sourceId}_${featureCount}" onclick="toggleSensitive(this)">
                <i class="fa-solid fa-lock" style="color: red;"></i> Sensitive
            </label>
            <label class="identifier-label">
                <input type="checkbox" name="identifier_${sourceId}_${featureCount}" onclick="toggleIdentifier(this, this.parentElement.previousElementSibling.value)">
                <i class="fa-solid fa-key"></i> UID
            </label>
            <label class="target-label">
                <input type="radio" name="target" onclick="toggleTarget(this)">
                <i class="fa-solid fa-bullseye"></i> Target
            </label>
            <button class="delete-button" onclick="deleteFeature(this)">
                <i class="fa-solid fa-trash"></i>
            </button>
        `;
        featureContainer.appendChild(featureDiv);
        updateTargetAndIdentifierOptions();
        updateVisualization();
    }

    function deleteFeature(button) {
        button.parentElement.remove();
        updateTargetAndIdentifierOptions();
        updateVisualization();
    }

    // Data Source Handling
    function addDataSource() {
        const container = document.getElementById('dataSources');
        const sourceCount = container.children.length + 1;
        const sourceDiv = document.createElement('div');
        sourceDiv.className = 'collapsible-card';
        sourceDiv.innerHTML = `
            <div class="collapsible-header" onclick="toggleCollapse(this)">
                <h3><i class="fa-solid fa-database"></i> Data Source ${sourceCount}</h3>
                <i class="fa-solid fa-chevron-down"></i>
                <button class="delete-button" onclick="deleteDataSource(this)">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
            <div class="collapsible-content">
                <label>Source Name:</label>
                <input type="text" name="source_name_${sourceCount}" placeholder="Enter source name" required>
                <label>Number of Features:</label>
                <input type="number" name="feature_count_${sourceCount}" placeholder="Number of features" min="1" required>
                <button class="btn-secondary" onclick="addFeature(${sourceCount})">
                    <i class="fa-solid fa-plus"></i> Add Feature
                </button>
                <div class="features" id="features_${sourceCount}"></div>
            </div>
        `;
        container.appendChild(sourceDiv);
        updateVisualization();
    }

    function deleteDataSource(button) {
        const card = button.closest('.collapsible-card');
        card.remove();
        updateVisualization();
    }

    function toggleCollapse(header) {
        const content = header.nextElementSibling;
        content.style.display = content.style.display === "none" ? "block" : "none";
    }

    // UID Handling
    function toggleIdentifier(element, featureName) {
        const allCheckboxes = document.querySelectorAll(`input[type="checkbox"][name^="identifier_"]`);

        // If there is already a global UID, ensure consistency
        if (globalUID && globalUID !== featureName) {
            alert("Error: UID must be consistent across all data sources! The UID name should match.");
            element.checked = false;
            return;
        }

        // Iterate over all checkboxes to maintain consistency
        allCheckboxes.forEach((checkbox) => {
            const checkboxName = checkbox.closest('.feature-item').querySelector('input[type="text"]').value;
            if (checkbox !== element && checkbox.checked && checkboxName !== featureName) {
                alert("Error: UID must be the same field name across all data sources!");
                element.checked = false;
                return;
            }
        });

        // Set the global UID if checked
        if (element.checked) {
            globalUID = featureName;
        } else {
            globalUID = null;
        }

        updateVisualization();
    }

    // Target and Identifier Options
    function updateTargetAndIdentifierOptions() {
        const targetSelect = document.getElementById("targetVariable");
        const identifierSelect = document.getElementById("identifierVariable");
        const features = document.querySelectorAll(".feature-item input[type='text']");

        targetSelect.innerHTML = "";
        identifierSelect.innerHTML = "";

        features.forEach((feature) => {
            const featureName = feature.value;
            if (featureName) {
                const targetOption = document.createElement("option");
                targetOption.value = featureName;
                targetOption.textContent = featureName;

                const identifierOption = document.createElement("option");
                identifierOption.value = featureName;
                identifierOption.textContent = featureName;

                targetSelect.appendChild(targetOption);
                identifierSelect.appendChild(identifierOption);
            }
        });
    }

    function toggleTarget(element) {
        const allTargetOptions = document.querySelectorAll("select#targetVariable option");
        allTargetOptions.forEach(option => {
            option.selected = (option.value === element.value);
        });
    }

    // Visualization Update
    function updateVisualization() {
        const visualization = document.getElementById('visualization');
        visualization.innerHTML = '';
        const sources = document.querySelectorAll('.collapsible-card');
        sources.forEach((source, index) => {
            const sourceName = source.querySelector('input[type="text"]').value;
            const featureElements = source.querySelectorAll('.feature-item');
            const featureList = Array.from(featureElements).map((el) => {
                const fieldName = el.querySelector('input[type="text"]').value;
                const isSensitive = el.querySelector('input[type="checkbox"][name^="sensitive"]').checked;
                const isIdentifier = el.querySelector('input[type="checkbox"][name^="identifier"]').checked;
                let icon = '';

                if (isIdentifier) icon = '<i class="fa-solid fa-key"></i>';
                if (isSensitive) icon += ' <i class="fa-solid fa-lock" style="color: red;"></i>';

                return `<li>${icon} ${fieldName}</li>`;
            });

            const sourceDiv = document.createElement('div');
            sourceDiv.className = 'visualization-table';
            sourceDiv.innerHTML = `<h4>${sourceName}</h4><ul>${featureList.join('')}</ul>`;
            visualization.appendChild(sourceDiv);
        });
    }
</script>
</body>
</html>
